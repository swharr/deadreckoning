name: Fetch and Process Petition Data

on:
  schedule:
    - cron: '0 17 * * *'   # 10:00am MT (UTC-7) daily
  workflow_dispatch:         # manual trigger from GitHub UI or CLI
  push:
    branches:
      - main                # push to main = production deploy
    paths:
      - 'data/manual/**'    # auto-trigger when xlsx dropped in data/manual/

jobs:
  fetch-and-process:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - run: pip install -r requirements.txt

      - name: Scrape LG site (manual file wins automatically if present)
        run: python scripts/scraper.py
        continue-on-error: true

      - name: Process data
        run: |
          if [ -f data/latest.xlsx ]; then
            python scripts/process.py
          else
            echo "No xlsx available â€” skipping process.py, keeping existing data.json"
          fi

      - name: Commit updated data.json and trigger deploy
        run: |
          git config user.name  "t8rsk8s-bot"
          git config user.email "bot@t8rsk8s.io"
          git add public/data.json
          git diff --staged --quiet || git commit -m "data: update $(date -u +%Y-%m-%d)"
          git push

  build-and-deploy:
    needs: fetch-and-process
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - run: npm run build

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_ICY_MUSHROOM_0DBB7A81E }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: "/"
          output_location: "dist"
          skip_app_build: true
