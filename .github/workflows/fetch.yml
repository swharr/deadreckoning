name: Fetch and Process Petition Data

on:
  schedule:
    - cron: '0 17 * * *'   # 10:00am MT (UTC-7) daily
  workflow_dispatch:         # manual trigger from GitHub UI or CLI
  push:
    branches:
      - main                # any push to main triggers deploy
    paths-ignore:
      - 'instructions/**'   # never trigger on gitignored instructions folder
      - '*.md'              # ignore readme-only changes

jobs:
  fetch-and-process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - run: pip install -r requirements.txt

      - name: Scrape LG site (manual file wins automatically if present)
        id: scrape
        run: |
          python scripts/scraper.py
          echo "changed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Mark unchanged if scraper exited cleanly with no new file
        if: steps.scrape.outcome == 'success'
        run: |
          # If latest.xlsx doesn't exist, scraper must have found nothing new
          if [ ! -f data/latest.xlsx ]; then
            echo "No xlsx available — skipping process.py"
          fi

      - name: Rebuild history and process data
        if: steps.scrape.outcome == 'success' && steps.scrape.outputs.changed == 'true'
        run: |
          if [ -f data/latest.xlsx ]; then
            python scripts/replay.py
            python scripts/process.py
          else
            echo "No xlsx available — skipping replay/process, keeping existing data"
          fi

      - name: Create PR with updated data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name  "t8rsk8s Data Robot"
          git config user.email "bot@t8rsk8s.io"
          git add data/snapshots/*.xlsx data/history.json public/data.json public/lookup.json
          if git diff --staged --quiet; then
            echo "No data changes — skipping PR"
            exit 0
          fi
          BRANCH="data/update-$(date -u +%Y-%m-%d-%H%M%S)"
          git checkout -b "$BRANCH"
          git commit -m "data: update $(date -u +%Y-%m-%d)"
          git push origin "$BRANCH"
          gh pr create \
            --title "data: update $(date -u +%Y-%m-%d)" \
            --body "Automated data update from t8rsk8s Data Robot." \
            --base main \
            --head "$BRANCH"
          gh pr merge "$BRANCH" --squash --delete-branch

  build-and-deploy:
    needs: fetch-and-process
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - run: npm run build

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_ICY_MUSHROOM_0DBB7A81E }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: "dist"
          skip_app_build: true
